name: "Charts: Renovate"

on:
  push:
    branches:
      - 'renovate/**'
    tags-ignore:
      - '**'

jobs:
  folderfix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: update folder names
        run: |
          for chart in charts/*; do
            if [ -d "${chart}" ]; then
                maxfolderversion=$(ls -l ${chart} | grep ^d | awk '{print $9}' | tail -n 1)
                maxchartversion=$(cat ${chart}/${maxfolderversion}/Chart.yaml | grep "^version: " | awk -F" " '{ print $2 }')
                chartname=$(basename ${chart})
                echo "Processing: ${chart} - folder: ${maxfolderversion} - version: ${maxchartversion}"
                if [ "${maxfolderversion}" != "${maxchartversion}" ]; then
                    mv -f ${chart}/${maxfolderversion} ${chart}/${maxchartversion}
                    echo "renamed ${chart}/${maxfolderversion} to ${chart}/${maxchartversion}"
                fi
            fi
          done

      - name: Commit and push updated charts
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add --all
          git commit --amend --no-edit  -a
          git push --force
