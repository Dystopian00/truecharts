name: "Apps: release-test"

on:
  pull_request:
    branches:
      - '**'
    tags-ignore:
      - '**'
    paths:
      - 'charts/**'
      - '.github/workflows/apps.test.yaml'
      - '.github/ct-install.yaml'
      - '.github/ct-lint.yaml'

jobs:
  release-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/truecharts/devcontainer:v2.2.1@sha256:4ace13c049bf00f85c63e0070f86b71656a7c3b2113aa3e21c3107f3d1f7bf87
    steps:
      - name: Cache helm repo cache
        id: cache
        uses: actions/cache@4b0cf6cc4619e737324ddfcec08fff2413359514 # tag=v3
        with:
          key: helmrepocache-${{ github.sha }}
          path: |
            ~/.cache/helm/repository
            ~/.config/helm/repositories.yaml

      - uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846 # tag=v3
        name: Checkout
        with:
          fetch-depth: 100

      - name: Checkout
        uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846 # tag=v3
        with:
          repository: truecharts/catalog
          path: catalog

      - name: build-and-run
        run: |
          tools/build-release.sh --config .github/cr.yaml
