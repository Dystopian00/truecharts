# Default values for Bitwarden.

image:
  repository: nextcloud
  pullPolicy: IfNotPresent
  tag: 22.1.1

strategy:
  type: Recreate

service:
  main:
    ports:
      main:
        port: 80
  hpb:
    enabled: true
    ports:
      hpb:
        enabled: true
        port: 7867

env:
  NEXTCLOUD_ADMIN_USER: "admin"
  NEXTCLOUD_ADMIN_PASSWORD: "adminpass"
  TRUSTED_PROXIES: "172.16.0.0/16"

envTpl:
  POSTGRES_DB: "{{ .Values.postgresql.postgresqlDatabase }}"
  POSTGRES_USER: "{{ .Values.postgresql.postgresqlUsername }}"

envFrom:
  - configMapRef:
      name: nextcloudconfig

envValueFrom:
  POSTGRES_PASSWORD:
    secretKeyRef:
      name: dbcreds
      key: postgresql-password
  POSTGRES_HOST:
    secretKeyRef:
      name: dbcreds
      key: host
  REDIS_HOST:
    secretKeyRef:
      name: rediscreds
      key: masterhost
  REDIS_HOST_PASSWORD:
    secretKeyRef:
      name: rediscreds
      key: redis-password

persistence:
  data:
    enabled: true
    mountPath: "/var/www/html"
    type: pvc
    accessMode: ReadWriteOnce
    size: "100Gi"

  redismaster:
    noMount: true
    forceName: "redismaster"
    enabled: true
    type: pvc
    accessMode: ReadWriteOnce
    size: "100Gi"

initContainers:
  - name: init-postgresdb
    image: postgres:13.1
    command:
      - "sh"
      - "-c"
      - "until pg_isready -U nextcloud -h ${pghost} ; do sleep 2 ; done"
    imagePullPolicy: IfNotPresent
    env:
      - name: pghost
        valueFrom:
          secretKeyRef:
            name: dbcreds
            key: plainhost
  - name: injectconfig
    image: nextcloud:22.1.1
    command:
      - "su"
      - "-p"
      - "www-data"
      - "-s"
      - "/bin/sh"
      - "-c"
    args:
      - if [ -f /var/www/html/occ ]; then
          if [ -n "${NEXTCLOUD_TRUSTED_DOMAINS+x}" ]; then
            echo "setting trusted domainsâ€¦";
            NC_TRUSTED_DOMAIN_IDX=1;
            for DOMAIN in $NEXTCLOUD_TRUSTED_DOMAINS ; do
              DOMAIN=$(echo "$DOMAIN" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//');
              php /var/www/html/occ config:system:set trusted_domains $NC_TRUSTED_DOMAIN_IDX --value=$DOMAIN;
              NC_TRUSTED_DOMAIN_IDX=$(($NC_TRUSTED_DOMAIN_IDX+1));
            done;
          fi;
        fi;
    volumeMounts:
      - mountPath: /var/www/html
        name: data


podSecurityContext:
  fsGroup: 33

# -- Probe configuration
# -- [[ref]](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/)
# @default -- See below
probes:
  # -- Liveness probe configuration
  # @default -- See below
  liveness:
    custom: true
    # -- If a HTTP probe is used (default for HTTP/HTTPS services) this path is used
    # @default -- "/"
    spec:
      httpGet:
        path: /status.php
        port: 80
        httpHeaders:
        - name: Host
          value: "test.fakedomain.dns"
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 2
      failureThreshold: 5

  # -- Redainess probe configuration
  # @default -- See below
  readiness:
    custom: true
    # -- If a HTTP probe is used (default for HTTP/HTTPS services) this path is used
    # @default -- "/"
    spec:
      httpGet:
        path: /status.php
        port: 80
        httpHeaders:
        - name: Host
          value: "test.fakedomain.dns"
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 2
      failureThreshold: 5

  # -- Startup probe configuration
  # @default -- See below
  startup:
    custom: true
    # -- If a HTTP probe is used (default for HTTP/HTTPS services) this path is used
    # @default -- "/"
    spec:
      httpGet:
        path: /status.php
        port: 80
        httpHeaders:
        - name: Host
          value: "test.fakedomain.dns"
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 2
      failureThreshold: 5


## Cronjob to execute Nextcloud background tasks
## ref: https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/background_jobs_configuration.html#webcron
##
cronjob:
  # Every 5 minutes
  # Note: Setting this to any any other value than 5 minutes might
  #  cause issues with how nextcloud background jobs are executed
  schedule: "*/5 * * * *"
  annotations: {}
  failedJobsHistoryLimit: 5
  successfulJobsHistoryLimit: 2

# Enabled postgres
postgresql:
  enabled: true
  postgresqlUsername: nextcloud
  postgresqlDatabase: nextcloud
  existingSecret: dbcreds

# Enabled redis
# ... for more options see https://github.com/bitnami/charts/tree/master/bitnami/redis
redis:
  volumePermissions:
    enabled: true
  architecture: standalone
  enabled: true
  auth:
    existingSecret: rediscreds
    existingSecretPasswordKey: redis-password
  master:
    persistence:
      enabled: false
      existingClaim: redismaster
  replica:
    replicaCount: 0
    persistence:
      enabled: false
