{{- include "tc.v1.common.loader.init" . }}

{{/* Define the broadcast proxy workload */}}
{{- define "broadcastProxy.workload" -}}
enabled: true
type: Deployment
podSpec:
  hostNetwork: true
  # Proxy doesn't seem to respect the TERM signal, so by default
  # this ends up just hanging until the default grace period ends.
  # This is unnecesary since this workload only proxies autodiscovery
  # messages.
  terminationGracePeriodSeconds: 3
  containers:
    broadcastproxy:
    {{ include "broadcastProxy.container" . | nindent 6 }}
{{- end -}}

{{- define "broadcastProxy.jellyfinAutodiscoveryService" -}}
enabled: true
ports:
  autodiscovery:
    enabled: true
    protocol: udp
    port: 7359
    targetPort: 7359
{{- end -}}


{{- if .Values.autodiscovery.enabled -}}
{{/* Replace published URL */}}
{{- $_ := set .Values.workload.main.podSpec.containers.main.env "JELLYFIN_PublishedServerUrl" .Values.autodiscovery.autodiscoveryUrl -}}
{{/* Append autodiscovery service */}}
{{- $_ := set .Values.service "autodiscovery" (include "broadcastProxy.jellyfinAutodiscoveryService" . | fromYaml) -}}
{{/* Add proxy workload */}}
{{- $_ := set .Values.workload "broadcastproxy" (include "broadcastProxy.workload" . | fromYaml) -}}
{{- end -}}


{{- include "tc.v1.common.loader.apply" . -}}
