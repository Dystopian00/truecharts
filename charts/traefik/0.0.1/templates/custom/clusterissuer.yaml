apiVersion: v1
kind: Secret
metadata:
  name: dns-secrets
type: Opaque
stringData:
  # cloudflare
  api-key: {{ .Values.certmanager.apikey | default "" }}
  # cloudDNS
  key-json: {{ .Values.certmanager.keyjson | default "" }}
  # route53
  secret-access-key: {{ .Values.certmanager.secretaccesskey | default "" }}
  # digitalocean
  access-token: {{ .Values.certmanager.accesstoken | default "" }}
  # rfc2136
  tsig-secret-key: {{ .Values.certmanager.tsigsecretkey | default "" }}
  # akamai
  clientToken: {{ .Values.certmanager.clientToken | default "" }}
  clientSecret: {{ .Values.certmanager.clientSecret | default "" }}
  accessToken: {{ .Values.certmanager.accessToken | default "" }}
  # acmeDNS
  acmedns-json: {{ .Values.certmanager.acmednsjson | default "" }}
---
{{- if .Values.certmanager.email -}}
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
  annotations:
   # hooks are defined here
   "helm.sh/hook": post-install,post-upgrade
   #"helm.sh/hook-weight": "0"
   "helm.sh/hook-delete-policy": before-hook-creation
spec:
  acme:
    # You must replace this email address with your own.
    # Let's Encrypt will use this to contact you about expiring
    # certificates, and issues related to your account.
    email: {{ .Values.certmanager.email }}
    server: https://acme-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      # Secret resource used to store the account's private key.
      name: issuer-account-key
    # Add a single challenge solver, DNS01
    solvers:
    - dns01:
        cloudflare:
          email: {{ .Values.certmanager.email }}
          apiKeySecretRef:
            name: dns-api-key-secret
            key: api-key
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
  #namespace: default
  annotations:
   # hooks are defined here
   "helm.sh/hook": post-install,post-upgrade
   #"helm.sh/hook-weight": "0"
   "helm.sh/hook-delete-policy": before-hook-creation
spec:
  acme:
    # You must replace this email address with your own.
    # Let's Encrypt will use this to contact you about expiring
    # certificates, and issues related to your account.
    email: {{ .Values.certmanager.email }}
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      # Secret resource used to store the account's private key.
      name: issuer-account-key
    # Add a single challenge solver, DNS01
    solvers:
    - dns01:
        {{- if eq .Values.certmanager.provider "cloudflare" -}}
        cloudflare:
          email: {{ .Values.certmanager.email }}
          apiKeySecretRef:
            name: dns-secrets
            key: api-key
        {{- else if eq .Values.certmanager.provider "cloudDNS" -}}
        cloudDNS:
        # The ID of the GCP project
          project: $PROJECT_ID
          # This is the secret used to access the service account
          serviceAccountSecretRef:
            name: dns-secrets
            key: key-json
        {{- else if eq .Values.certmanager.provider "route53" -}}
        route53:
          region: eu-central-1
          accessKeyID: AKIAIOSFODNN7EXAMPLE
          secretAccessKeySecretRef:
            name: dns-secrets
            key: secret-access-key
          # you can also assume a role with these credentials
          role: arn:aws:iam::YYYYYYYYYYYY:role/dns-manager
        {{- else if eq .Values.certmanager.provider "digitalocean" -}}
        digitalocean:
          tokenSecretRef:
            name: dns-secrets
            key: access-token
        {{- else if eq .Values.certmanager.provider "rfc2136" -}}
        rfc2136:
         nameserver: 1.2.3.4:53
         tsigKeyName: example-com-secret
         tsigAlgorithm: HMACSHA512
         tsigSecretSecretRef:
           name: dns-secrets
           key: tsig-secret-key
        {{- else if eq .Values.certmanager.provider "azureDNS" -}}
        azureDNS:
          subscriptionID: AZURE_SUBSCRIPTION_ID
          resourceGroupName: AZURE_DNS_ZONE_RESOURCE_GROUP
          hostedZoneName: AZURE_DNS_ZONE
          # Azure Cloud Environment, default to AzurePublicCloud
          environment: AzurePublicCloud
        {{- else if eq .Values.certmanager.provider "akamai" -}}
        akamai:
          serviceConsumerDomain: akab-tho6xie2aiteip8p-poith5aej0ughaba.luna.akamaiapis.net
          clientTokenSecretRef:
            name: dns-secrets
            key: clientToken
          clientSecretSecretRef:
            name: dns-secrets
            key: clientSecret
          accessTokenSecretRef:
            name: dns-secrets
            key: accessToken
        {{- else if eq .Values.certmanager.provider "acmeDNS" -}}
        acmeDNS:
          host: https://acme.example.com
          accountSecretRef:
            name: dns-secrets
            key: acmedns-json
        {{- end }}
{{- end }}
