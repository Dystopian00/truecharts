image:
  repository: tccr.io/truecharts/bar-assistant-web
  pullPolicy: IfNotPresent
  tag: v1.20.1@sha256:326dbb6b21263dd1959c7464f2c25702b38a0fb481164c4a077ea33f60d8288e
nginxImage:
  repository: tccr.io/truecharts/nginx-unprivileged
  pullPolicy: IfNotPresent
  tag: v1.25.1@sha256:570548a099b61ae4f185b0778193504930d2b853ce2ac8be767e55ab5de5aba5
apiImage:
  repository: tccr.io/truecharts/bar-assistant-api
  pullPolicy: IfNotPresent
  tag: v2.5.3@sha256:2a2428c6237e4ff997a1618bef93a6b0da1279851c4bfbb46790cbc322a501ff
searchImage:
  repository: tccr.io/truecharts/meilisearch
  pullPolicy: IfNotPresent
  tag: v1.3.1@sha256:419286f036f3c87d50860a035606ef7ad54a7af5efc37727dd7353435740dcb2

service:
  main:
    targetSelector: nginx
    ports:
      main:
        targetSelector: nginx
        protocol: http
        port: 8082
  web:
    enabled: true
    type: ClusterIP
    targetSelector: main
    ports:
      web:
        enabled: true
        targetSelector: main
        targetPort: 8080
        port: 8080
  api:
    enabled: true
    type: ClusterIP
    targetSelector: api
    ports:
      api:
        enabled: true
        targetSelector: api
        targetPort: 3000
        port: 3000
  search:
    enabled: true
    type: ClusterIP
    targetSelector: search
    ports:
      search:
        enabled: true
        targetSelector: search
        targetPort: 7700
        port: 7700

saltrim:
  name: "TrueCharts Salt Rim"
  description: "An OpenSauce Bar"
  locale: "en-US"
  allow_reg: false
  disable_login: false

workload:
  main:
    podSpec:
      containers:
        main:
          imageSelector: image
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            runAsNonRoot: false
            readOnlyRootFilesystem: false
            pod:
              fsGroup: 33
          probes:
            liveness:
              enabled: true
              path: "/api"
              type: http
              port: "{{ .Values.service.api.ports.api.targetPort }}"
            readiness:
              enabled: true
              path: "/api"
              type: http
              port: "{{ .Values.service.api.ports.api.targetPort }}"
            startup:
              enabled: true
              path: "/api"
              type: tcp
              port: "{{ .Values.service.api.ports.api.targetPort }}"
          env:
            API_URL: "/bar"
            MEILISEARCH_URL: "/search"
            BAR_NAME: "{{ .Values.saltrim.name }}"
            DESCRIPTION: "{{ .Values.saltrim.description }}"
            DEFAULT_LOCALE: "{{ .Values.saltrim.locale }}"
            DISABLE_LOGIN: "{{ .Values.saltrim.disable_login }}"
  nginx:
    enabled: true
    type: Deployment
    podSpec:
      containers:
        nginx:
          enabled: true
          primary: true
          imageSelector: nginxImage
          probes:
            readiness:
              enabled: true
              path: /
              port: "{{ .Values.service.main.ports.main.port }}"
            liveness:
              enabled: true
              path: /
              port: "{{ .Values.service.main.ports.main.port }}"
            startup:
              enabled: true
              type: tcp
              port: "{{ .Values.service.main.ports.main.port }}"
  api:
    enabled: true
    type: Deployment
    podSpec:
      containers:
        api:
          primary: true
          enabled: true
          imageSelector: apiImage
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            runAsNonRoot: false
            readOnlyRootFilesystem: false
            pod:
              fsGroup: 33
          probes:
            liveness:
              enabled: true
              type: http
              path: /api
              port: "{{ .Values.service.api.ports.api.targetPort }}"
            readiness:
              enabled: true
              type: http
              path: /api
              port: "{{ .Values.service.api.ports.api.targetPort }}"
            startup:
              enabled: true
              type: http
              path: /api
              port: "{{ .Values.service.api.ports.api.targetPort }}"
          env:
            APP_URL: "/bar"
            DISABLE_LOGIN: "{{ .Values.saltrim.disable_login }}"
            SCOUT_DRIVER: meilisearch
            MEILISEARCH_HOST: '{{ printf "http://%v-search:%v/search" (include "tc.v1.common.lib.chart.names.fullname" $) .Values.service.search.ports.search.targetPort }}'
            MEILISEARCH_KEY:
              secretKeyRef:
                name: saltrim-secrets
                key: MEILI_MASTER_KEY
            APP_KEY:
              secretKeyRef:
                name: saltrim-secrets
                key: APP_KEY
            # DB_CONNECTION: "pgsql"
            # DB_USERNAME: "{{ .Values.cnpg.main.user }}"
            # DB_DATABASE: "{{ .Values.cnpg.main.database }}"
            # DB_PORT: 5432
            # DB_HOST:
            #   secretKeyRef:
            #     name: cnpg-main-urls
            #     key: host
            # DB_PASSWORD:
            #   secretKeyRef:
            #     name: cnpg-main-user
            #     key: password
            # CACHE_DRIVER: redis
            # SESSION_DRIVER: redis
            REDIS_HOST:
              secretKeyRef:
                expandObjectName: false
                name: '{{ printf "%s-%s" .Release.Name "rediscreds" }}'
                key: url
            REDIS_PASSWORD:
              secretKeyRef:
                expandObjectName: false
                name: '{{ printf "%s-%s" .Release.Name "rediscreds" }}'
                key: redis-password
  search:
    enabled: true
    type: Deployment
    podSpec:
      containers:
        search:
          primary: true
          enabled: true
          imageSelector: searchImage
          probes:
            liveness:
              enabled: true
              type: http
              path: /
              port: "{{ .Values.service.search.ports.search.targetPort }}"
            readiness:
              enabled: true
              type: http
              path: /
              port: "{{ .Values.service.search.ports.search.targetPort }}"
            startup:
              enabled: true
              type: tcp
              path: /
              port: "{{ .Values.service.search.ports.search.targetPort }}"
          env:
            MEILI_MASTER_KEY:
              secretKeyRef:
                name: saltrim-secrets
                key: MEILI_MASTER_KEY

persistence:
  nginx:
    enabled: true
    type: configmap
    objectName: nginx-config
    targetSelector:
      nginx:
        nginx:
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
          readOnly: true
  server:
    enabled: true
    targetSelector:
      api:
        api:
          mountPath: /var/www/cocktails/storage/bar-assistant
  search:
    enabled: true
    targetSelector:
      search:
        search:
          mountPath: /meili_data

# will be available following a major release.
# cnpg:
#   main:
#     enabled: false
#     user: saltrim
#     database: saltrim

redis:
  enabled: true

portal:
  open:
    enabled: true
