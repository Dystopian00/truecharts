image:
  repository: hyzual/koel
  tag: latest@sha256:fa4bafbe3ae869f153bdc3bc87db739f300bef6cc94e398d7efa587a443f86fa
  pullPolicy: IfNotPresent

securityContext:
  readOnlyRootFilesystem: false

podSecurityContext:
  runAsUser: 33
  runAsGroup: 33

env:
  DB_CONNECTION: "pgsql"
  DB_USERNAME: "{{ .Values.postgresql.postgresqlUsername }}"
  DB_DATABASE: "{{ .Values.postgresql.postgresqlDatabase }}"
  FORCE_HTTPS: false
  MEMORY_LIMIT: 2048
  LASTFM_API_KEY: ""
  LASTFM_API_SECRET: ""
  YOUTUBE_API_KEY: ""

service:
  main:
    ports:
      main:
        port: 10185
        targetPort: 80

envValueFrom:
  DB_HOST:
    secretKeyRef:
      name: dbcreds
      key: plainhost
  DB_PASSWORD:
    secretKeyRef:
      name: dbcreds
      key: postgresql-password
  APP_KEY:
    secretKeyRef:
      name: koel-secrets
      key: APP_KEY

installContainers:
  initDB:
    image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
    volumeMounts:
      - name: music
        mountPath: "/music"
      - name: covers
        mountPath: "/var/www/html/public/img/covers"
      - name: searchindex
        mountPath: "/var/www/html/storage/search-indexes"
    env:
      - name: DB_CONNECTION
        value: "pgsql"
      - name: DB_USERNAME
        value: "{{ .Values.postgresql.postgresqlUsername }}"
      - name: DB_USERNAME
        value: "{{ .Values.postgresql.postgresqlUsername }}"
      - name: DB_DATABASE
        value: "{{ .Values.postgresql.postgresqlDatabase }}"
      - name: DB_HOST
        valueFrom:
          secretKeyRef:
            name: dbcreds
            key: plainhost
      - name: DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: dbcreds
            key: postgresql-password
      - name: APP_KEY
        valueFrom:
          secretKeyRef:
            name: koel-secrets
            key: APP_KEY
    command: ["php", "artisan", "koel:init", "--no-assets"]

persistence:
  music:
    enabled: true
    mountPath: "/music"
  covers:
    enabled: true
    mountPath: "/var/www/html/public/img/covers"
  searchindex:
    enabled: true
    mountPath: "/var/www/html/storage/search-indexes"

postgresql:
  enabled: true
  existingSecret: "dbcreds"
  postgresqlUsername: koel
  postgresqlDatabase: koel
