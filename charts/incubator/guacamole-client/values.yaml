image:
  repository: tccr.io/truecharts/guacamole-client
  pullPolicy: IfNotPresent
  tag: v1.4.0@sha256:43f7b0575173f509b5215a89170dfea80ea07f0b2bfed405882a4bc7ec9dfa52

portal:
  path: "/guacamole"

# guacamole user = 1001
podSecurityContext:
  runAsUser: 1001
  runAsGroup: 1001

securityContext:
  # runAsNonRoot: false
  readOnlyRootFilesystem: false

service:
  main:
    ports:
      main:
        port: 10080
        targetPort: 8080

env:
  POSTGRES_DATABASE: "{{ .Values.postgresql.postgresqlDatabase }}"
  POSTGRES_USER: "{{ .Values.postgresql.postgresqlUsername }}"
  POSTGRES_PORT: 5432
  GUACD_HOSTNAME: "localhost"
  GUACD_PORT: 4822
  TOTP_ENABLED: false

postgresql:
  enabled: true
  existingSecret: "dbcreds"
  postgresqlUsername: guacamole
  postgresqlDatabase: guacamole

envValueFrom:
  POSTGRES_HOSTNAME:
    secretKeyRef:
      name: dbcreds
      key: plainhost
  POSTGRES_PASSWORD:
    secretKeyRef:
      name: dbcreds
      key: postgresql-password

probes:
  liveness:
    path: "/guacamole"
  readiness:
    path: "/guacamole"
  startup:
    path: "/guacamole"

persistence:
  initdbdata:
    enabled: true
    mountPath: "/initdbdata"
  temphack:
    enabled: true
    mountPath: "/opt/guacamole/postgresql"

initContainers:
  1-creat-initdb-file:
    image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
    volumeMounts:
      - name: initdbdata
        mountPath: "/initdbdata"
    command: ["/bin/sh", "-c"]
    args:
      - >
        echo "Creating initdb.sql file...";
        /opt/guacamole/bin/initdb.sh --postgres > /initdbdata/initdb.sql;
        if [ -e /initdbdata/initdb.sql ];
        then
          echo "Init file created successfully!";
          exit 0;
        else
          echo "Init file failed to create.";
          exit 1;
        fi;
  2-initdb:
    image: "{{ .Values.postgresqlImage.repository }}:{{ .Values.postgresqlImage.tag }}"
    env:
      - name: POSTGRES_DATABASE
        value: "{{ .Values.postgresql.postgresqlDatabase }}"
      - name: POSTGRES_USER
        value: "{{ .Values.postgresql.postgresqlUsername }}"
      - name: POSTGRES_PORT
        value: "5432"
      - name: POSTGRES_HOSTNAME
        valueFrom:
          secretKeyRef:
            name: dbcreds
            key: plainhost
      - name: PGPASSWORD
        valueFrom:
          secretKeyRef:
            name: dbcreds
            key: postgresql-password
    volumeMounts:
      - name: initdbdata
        mountPath: "/initdbdata"
    command: ["/bin/sh", "-c"]
    args:
      - >
        echo "Waiting for DB to be ready...";
        DBREADY=0;
        for i in {1..10};
        do pg_isready -t 5 -h $POSTGRES_HOSTNAME -d $POSTGRES_DATABASE -U $POSTGRES_USER -p $POSTGRES_PORT;
          if [ $? -eq 0 ];
            then echo "DB is ready!";
              DBREADY=1;
              break;
            else echo "DB not ready yet.";
          fi;
          echo "Waiting...";
          sleep 5;
        done;
        if [ $DBREADY -eq 1 ];
        then echo "Initializing DB's schema...";
          psql -h $POSTGRES_HOSTNAME -d $POSTGRES_DATABASE -U $POSTGRES_USER -p $POSTGRES_PORT -a -w -f /initdbdata/initdb.sql;
          if [ $? -eq 0 ];
            then echo "DB's schema initialized successfully!";
              exit 0;
            else echo "DB's schema failed to initialize.";
              exit 1;
          fi;
        else echo "DB failed to start.";
        fi;

    # Until they release an image with the updated driver, we need to manually replace it.
    # https://issues.apache.org/jira/browse/GUACAMOLE-1433
    # https://github.com/apache/guacamole-client/pull/655
  3-temp-hack:
    image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
    securityContext:
      runAsUser: 1001
      runAsGroup: 1001
    volumeMounts:
      - name: temphack
        mountPath: "/opt/guacamole/postgresql"
    command: ["/bin/sh", "-c"]
    args:
    - >
      echo "Checing postgresql driver version...";
      echo "Debug test show contents1:";
      ls -la /opt/guacamole/postgresql/;
      if [ -e /opt/guacamole/postgresql/postgresql-42.2.24.jre7.jar ];
        then echo "Version found is correct.";
          exit 0;
        elif [-e /opt/guacamole/postgresql/postgresql-9.4-1201.jdbc41.jar ];
          then echo "Old version found.";
            echo "Removing old version... (postgresql-9.4-1201.jdbc41.jar)";
            rm "/opt/guacamole/postgresql/postgresql-9.4-1201.jdbc41.jar";
            if [ $? -eq 0 ];
              then echo "Removed successfully!";
              else "Failed to remove.";
                exit 1;
            fi;
        else echo "Version not found. Will try to download a known-to-work version.";
          echo "Downloading (postgresql-42.2.24.jre7.jar)...";
          curl -L "https://jdbc.postgresql.org/download/postgresql-42.2.24.jre7.jar" > "/opt/guacamole/postgresql/postgresql-42.2.24.jre7.jar";
          if [ -e /opt/guacamole/postgresql/postgresql-42.2.24.jre7.jar ];
            then echo "Downloaded successfully!";
              echo "Debug test show contents2:";
              ls -la /opt/guacamole/postgresql/;
            else echo "Failed to download.";
              exit 1;
          fi;
      fi;
