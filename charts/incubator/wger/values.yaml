image:
  repository: wger/server
  tag: latest@sha256:504626e67e709b00a23fb2daf8edd420f30b9e2d1c2c72efb2c3e3907fc636a1
  pullPolicy: IfNotPresent

nginxImage:
  repository: tccr.io/truecharts/nginx
  tag: v1.22.0@sha256:9829252d9891aa3dfc654df8a98f65567ca8b43683e3ef2898944bc44287aeef

command: ["cat", "/etc/passwd"]
securityContext:
  runAsNonRoot: false
  readOnlyRootFilesystem: false

podSecurityContext:
  runAsUser: 0
  runAsGroup: 0

env:
  DJANGO_DB_ENGINE: "django.db.backends.postgresql"
  DJANGO_DB_DATABASE: "{{ .Values.postgresql.postgresqlDatabase }}"
  DJANGO_DB_USER: "{{ .Values.postgresql.postgresqlUsername }}"
  DJANGO_DB_PORT: "5432"
  DJANGO_DB_HOST:
    secretKeyRef:
      name: dbcreds
      key: plainhost
  DJANGO_DB_PASSWORD:
    secretKeyRef:
      name: dbcreds
      key: postgresql-password
  DJANGO_CACHE_BACKEND: "django_redis.cache.RedisCache"
  DJANGO_CACHE_CLIENT_CLASS: "django_redis.client.DefaultClient"
  DJANGO_CACHE_TIMEOUT: "1296000"
  DJANGO_CACHE_LOCATION:
    secretKeyRef:
      name: rediscreds
      key: url
  SECRET_KEY:
    secretKeyRef:
      name: wger-secrets
      key: SECRET_KEY
  TIME_ZONE: "{{ .Values.TZ }}"
  WGER_USE_GUNICORN: true
  # User Defined
  SITE_URL: "http://localhost:8000"
  FROM_EMAIL: "info@example.com"
  SYNC_EXERCISES_ON_STARTUP: false
  DOWNLOAD_EXERCISE_IMAGES_ON_STARTUP: false
  ALLOW_REGISTRATION: true
  ALLOW_GUEST_USERS: true
  ALLOW_UPLOAD_VIDEOS: true
  EXERCISE_CACHE_TTL: 3600
  DJANGO_PERFORM_MIGRATIONS: true
  DJANGO_DEBUG: false
  # ENABLE_EMAIL: false
  # EMAIL_HOST: ""
  # EMAIL_PORT: ""
  # EMAIL_HOST_USER: ""
  # EMAIL_HOST_PASSWORD: ""
  # EMAIL_USE_TLS: false
  # EMAIL_USE_SSL: false
  # RECAPTCHA_PUBLIC_KEY: ""
  # RECAPTCHA_PRIVATE_KEY: ""
  # NOCAPTCHA: ""

configmap:
  config:
    enabled: true
    data:
      nginx-config: |-
        upstream wger {
            server localhost:8000;
        }
        server {
            listen 80;
            location / {
                proxy_pass http://localhost;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $host;
                proxy_redirect off;
            }
            location /static/ {
                alias /static/;
            }
            location /media/ {
                alias /media/;
            }
            # Increase max body size to allow for video uploads
            client_max_body_size 100M;
        }

probes:
  liveness:
    path: "/"
  readiness:
    path: "/"
  startup:
    path: "/"

service:
  main:
    ports:
      main:
        port: 10249
        targetPort: 80

installContainers:
  migration:
    image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
    env:
      - name: FROM_EMAIL
        value: "info@example.com"
      - name: SITE_URL
        value: "{{ .Values.env.SITE_URL }}"
      - name: DJANGO_DB_ENGINE
        value: "{{ .Values.env.DJANGO_DB_ENGINE }}"
      - name: DJANGO_DB_DATABASE
        value: "{{ .Values.postgresql.postgresqlDatabase }}"
      - name: DJANGO_DB_USER
        value: "{{ .Values.postgresql.postgresqlUsername }}"
      - name: DJANGO_DB_PORT
        value: "{{ .Values.env.DJANGO_DB_PORT }}"
      - name: DJANGO_DB_HOST
        valueFrom:
          secretKeyRef:
            name: dbcreds
            key: plainhost
      - name: DJANGO_DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: dbcreds
            key: postgresql-password
      - name: DJANGO_CACHE_TIMEOUT
        value: "{{ .Values.env.DJANGO_CACHE_TIMEOUT }}"
      - name: DJANGO_CACHE_BACKEND
        value: "{{ .Values.env.DJANGO_CACHE_BACKEND }}"
      - name: DJANGO_CACHE_CLIENT_CLASS
        value: "{{ .Values.env.DJANGO_CACHE_CLIENT_CLASS }}"
      - name: DJANGO_CACHE_LOCATION
        valueFrom:
          secretKeyRef:
            name: rediscreds
            key: url
      - name: SECRET_KEY
        valueFrom:
          secretKeyRef:
            name: wger-secrets
            key: SECRET_KEY
    volumeMounts:
    - name: media
      mountPath: "/home/wger/media"
    - name: static
      mountPath: "/home/wger/static"
    command: ["/bin/sh", "-c"]
    args:
      - >
        echo 'Migrating';
        python3 manage.py migrate sites;
        python3 manage.py migrate;

additionalContainers:
  nginx:
    name: nginx
    image: "{{ .Values.nginxImage.repository }}:{{ .Values.nginxImage.tag }}"
    ports:
      - containerPort: 80
        name: main
    volumeMounts:
    - name: wger-config
      mountPath: "/etc/nginx/conf.d/default.conf"
      subPath: nginx-config
      readOnly: true
    - name: media
      mountPath: "/media"
    - name: static
      mountPath: "/static"

persistence:
  media:
    enabled: true
    mountPath: "/home/wger/media"
  static:
    enabled: true
    type: emptyDir
    mountPath: "/home/wger/static"
  wger-config:
    enabled: "true"
    mountPath: "/etc/nginx/conf.d/default.conf"
    subPath: "default.conf"
    type: "custom"
    volumeSpec:
      configMap:
        name: '{{ printf "%v-config" (include "tc.common.names.fullname" .) }}'

postgresql:
  enabled: true
  existingSecret: "dbcreds"
  postgresqlUsername: wger
  postgresqlDatabase: wger

redis:
  enabled: true
  existingSecret: "rediscreds"
