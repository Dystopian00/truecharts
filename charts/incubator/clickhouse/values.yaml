image:
  repository: yandex/clickhouse-server
  pullPolicy: IfNotPresent
  tag: 21.3.20.1@sha256:4eccfffb01d735ab7c1af9a97fbff0c532112a6871b2bb5fe5c478d86d247b7e

controller:
  type: statefulset
  strategy: RollingUpdate
  rollingUpdate:
    unavailable: 1

securityContext:
  readOnlyRootFilesystem: false
  capabilities:
    add:
      # TODO: remove capabilities for unused ClickHouse features. See also:
      # https://github.com/ClickHouse/ClickHouse/blob/master/docker/server/README.md#linux-capabilities
      # https://kb.altinity.com/altinity-kb-setup-and-maintenance/altinity-kb-clickhouse-in-docker/
      - IPC_LOCK
      - NET_ADMIN
      - SYS_NICE
      - SYS_PTRACE

service:
  main:
    ports:
      main:
        port: 8123
        protocol: HTTP
        targetPort: 8123

volumeClaimTemplates:
  data:
    enabled: true
    mountPath: /var/lib/clickhouse

probes:
  liveness:
    custom: true
    spec:
      httpGet:
        path: /ping
        port: 8123
      initialDelaySeconds: 30
      failureThreshold: 3
      periodSeconds: 10
      timeoutSeconds: 1
  readiness:
    custom: true
    spec:
      httpGet:
        path: /ping
        port: 8123
      initialDelaySeconds: 20
      failureThreshold: 6
      periodSeconds: 10
      timeoutSeconds: 1
  startup:
    custom: true
    spec:
      httpGet:
        path: /ping
        port: 8123
      initialDelaySeconds: 20
      periodSeconds: 10
      timeoutSeconds: 1

clickhouseDatabase: "test"
clickhouseUsername: "test"
clickhousePassword: "testpass"
clickhouseDefaultAccessManagement: 0
existingSecret: ""

secret:
  credentials:
    enabled: true
    data:
      clickhouse-password: '{{ ( .Values.clickhousePassword | default "empty" ) }}'

env:
  CLICKHOUSE_DB: "{{ .Values.clickhouseDatabase }}"
  CLICKHOUSE_USER: "{{ .Values.clickhouseUsername }}"
  CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: "{{ .Values.clickhouseDefaultAccessManagement }}"
  CLICKHOUSE_PASSWORD:
    secretKeyRef:
      name: '{{ .Values.existingSecret | default ( printf "%s-credentials" ( include "tc.common.names.fullname" . ) ) }}'
      key: "clickhouse-password"
