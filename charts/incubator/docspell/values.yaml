image:
  repository: docspell/restserver
  tag: v0.31.0@sha256:4faf2b35598e9e7e1f9add59130ca9cf43ccbca675011b2ff5f772ae55e19b21
  pullPolicy: IfNotPresent

joexImage:
  repository: docspell/joex
  tag: v0.31.0@sha256:05ad93fc95e9178d3ecd270438d41a237060a4d8546815c6488c687c9b854671

solrImage:
  repository: solr
  tag: 8.11.1@sha256:4f7445630b788708b070ec3a18d21d4a2cb40d79c373ede76720633e936e9d41

securityContext:
  readOnlyRootFilesystem: false
  runAsNonRoot: false

podSecurityContext:
  runAsUser: 0
  runAsGroup: 0

secret:
  # If empty, endpoint is disabled
  DOCSPELL_SERVER_ADMIN__ENDPOINT_SECRET: ""
  # If empty a random will be generated, this is to sign authenticator tokens # TODO: We should generate one and store it to secrets
  DOCSPELL_SERVER_AUTH_SERVER__SECRET: ""
  # Header secret for the integration endpoint
  DOCSPELL_SERVER_INTEGRATION__ENDPOINT_HTTP__HEADER_HEADER__VALUE: "http-header-secret"
  # HTTP Header name for integration endpoint
  DOCSPELL_SERVER_INTEGRATION__ENDPOINT_HTTP__HEADER_HEADER__NAME: "docspell-integration-header"
  # User for http basic for integration endpoint
  DOCSPELL_SERVER_INTEGRATION__ENDPOINT_HTTP__BASIC_USER: "basic-user"
  # Password for http basic for integration endpoint
  DOCSPELL_SERVER_INTEGRATION__ENDPOINT_HTTP__BASIC_PASSWORD: "basic-password"
  # Realm for http basic for integration endpoint
  DOCSPELL_SERVER_INTEGRATION__ENDPOINT_HTTP__BASIC_REALM: "Docspell Integration Realm"
  # When mode = "invite", this password will be used to generate inv keys
  DOCSPELL_SERVER_BACKEND_SIGNUP_NEW__INVITE__PASSWORD: "new-invite-generator-password"

env:
  TZ: "UTC"
  DOCSPELL_SERVER_BACKEND_JDBC_USER: "{{ .Values.postgresql.postgresqlUsername }}"
  # App ID should be unique on each node
  DOCSPELL_SERVER_APP__ID: '{{ randAlphaNum 10 }}'
  # App name to show on the top right corner
  DOCSPELL_SERVER_APP__NAME: "Docspell On Helm"
  # Enable "Remember Cookie/Token
  DOCSPELL_SERVER_AUTH_REMEMBER__ME_ENABLED: true
  # Cookie/Token Valid for
  DOCSPELL_SERVER_AUTH_REMEMBER__ME_VALID: "30 days"
  # Authetication token valid for
  DOCSPELL_SERVER_AUTH_SESSION__VALID: "5 minutes"
  # Chunk size used to store files in db and in ram while up/down
  DOCSPELL_SERVER_BACKEND_FILES_CHUNK__SIZE: 524288
  # Enable debugging for mail
  DOCSPELL_SERVER_BACKEND_MAIL__DEBUG: false
  # When mode ="invite", invite is valid for
  DOCSPELL_SERVER_BACKEND_SIGNUP_INVITE__TIME: "3 days"
  # ["open", "invite", "closed"]
  DOCSPELL_SERVER_BACKEND_SIGNUP_MODE: "open"
  # Enable full text search
  DOCSPELL_SERVER_FULL__TEXT__SEARCH_ENABLED: true
  # Tell solr when to commit the data
  DOCSPELL_SERVER_FULL__TEXT__SEARCH_SOLR_COMMIT__WITHIN: 1000
  # SOLR parser
  DOCSPELL_SERVER_FULL__TEXT__SEARCH_SOLR_DEF__TYPE: "lucene"
  # Enable SOLR debbuging
  DOCSPELL_SERVER_FULL__TEXT__SEARCH_SOLR_LOG__VERBOSE: false
  # Default combiner for tokens ["OR","AND"]
  DOCSPELL_SERVER_FULL__TEXT__SEARCH_SOLR_Q__OP: "OR"
  # This url is the base url for reaching this server internally.
  DOCSPELL_SERVER_INTERNAL__URL: 'http://{{ include "common.names.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.main.ports.main.port }}'
  # Base URL eg https://doc.mydomain.com TODO: Set this automatically?
  DOCSPELL_SERVER_BASE__URL: 'http://{{ include "common.names.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.main.ports.main.port }}'
  # The priority to use when uploading to this endpoint
  DOCSPELL_SERVER_INTEGRATION__ENDPOINT_PRIORITY: "low"
  # The name used for the item source property
  DOCSPELL_SERVER_INTEGRATION__ENDPOINT_SOURCE__NAME: "integration"
  # Hard limit to search returns
  DOCSPELL_SERVER_MAX__ITEM__PAGE__SIZE: 200
  # Hard limit for char lenght on search
  DOCSPELL_SERVER_MAX__NOTE__LENGTH: 180
  # Show classification form
  DOCSPELL_SERVER_SHOW__CLASSIFICATION__SETTINGS: true
  # SOLR URL
  DOCSPELL_SERVER_FULL__TEXT__SEARCH_SOLR_URL: 'http://{{ include "common.names.fullname" . }}-solr.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.solr.ports.solr.port }}/solr/docspell'
  # Enable the integration endpoint
  DOCSPELL_SERVER_INTEGRATION__ENDPOINT_ENABLED: false
  # Enable the allowed IPs, for the integration endpoint (No env to set the ips?!)
  DOCSPELL_SERVER_INTEGRATION__ENDPOINT_ALLOWED__IPS_ENABLED: false
  # Enable HTTP Basic for  integrtion endpoint
  DOCSPELL_SERVER_INTEGRATION__ENDPOINT_HTTP__BASIC_ENABLED: false
  # Enable HTTP Header for integration endpoint
  DOCSPELL_SERVER_INTEGRATION__ENDPOINT_HTTP__HEADER_ENABLED: false
  DOCSPELL_SERVER_BIND_ADDRESS: "0.0.0.0"
  DOCSPELL_SERVER_BIND_PORT: "{{ .Values.service.main.ports.main.port }}"
  RELNAME: "{{ .Release.Name }}"
  FULNAME: '{{ include "common.names.fullname" . }}'

envValueFrom:
  DOCSPELL_SERVER_BACKEND_JDBC_PASSWORD:
    secretKeyRef:
      name: dbcreds
      key: postgresql-password
  DOCSPELL_SERVER_BACKEND_JDBC_URL:
    secretKeyRef:
      name: dbcreds
      key: jdbc

service:
  main:
    ports:
      main:
        port: 7880
        targetPort: 7880
  solr:
    ports:
      solr:
        port: 8983
        # Set this based on `additionalContainers.solr.ports[0].containerPort`
        targetPort: 8983
  joex:
    ports:
      joex:
        port: 7878
        # Set this based on `additionalContainers.joex.ports[0].containerPort`
        targetPort: 7878

additionalContainers:
  solr:
    name: solr
    image: "{{ .Values.solrImage.repository }}:{{ .Values.solrImage.tag }}"
    ports:
      - containerPort: 8983
        name: main
    command:
      - solr-precreate
      - docspell
    volumeMounts:
    - name: solr
      mountPath: "/var/solr"
    livenessProbe:
      exec:
      # TODO: Figure out the dns genertaion for additional containers
        command: ["curl", "-f", 'http://{{ include "common.names.fullname" . }}-solr.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.solr.ports.solr.port }}/solr/docspell/admin/ping']
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 5
    readinessProbe:
      exec:
      # TODO: Figure out the dns genertaion for additional containers
        command: ["curl", "-f", 'http://{{ include "common.names.fullname" . }}-solr.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.solr.ports.solr.port }}/solr/docspell/admin/ping']
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 5
  joex:
    name: joex
    image: "{{ .Values.joexImage.repository }}:{{ .Values.joexImage.tag }}"
    securityContext:
      runAsUser: 0
      runAsNonRoot: false
    ports:
      - containerPort: 7878
        name: main
    env:
      - name: TZ
        value: "{{ .Values.env.TZ }}"
      - name: DOCSPELL_JOEX_JDBC_USER
        value: "{{ .Values.postgresql.postgresqlUsername }}"
      - name: DOCSPELL_JOEX_JDBC_URL
        valueFrom:
          secretKeyRef:
            name: dbcreds
            key: jdbc
      - name: DOCSPELL_JOEX_JDBC_PASSWORD
        valueFrom:
          secretKeyRef:
            name: dbcreds
            key: postgresql-password
      - name: DOCSPELL_JOEX_BASE__URL
      # TODO: Figure out the dns genertaion for additional containers
        value: 'http://{{ include "common.names.fullname" . }}-joex.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.joex.ports.joex.targetPort }}'
      - name: DOCSPELL_JOEX_BIND_ADDRESS
        value: "0.0.0.0"
      - name: DOCSPELL_JOEX_BIND_PORT
        value: "{{ .Values.service.joex.ports.joex.targetPort }}"
      - name: DOCSPELL_JOEX_FULL__TEXT__SEARCH_ENABLED
        value: "true"
      - name: DOCSPELL_JOEX_FULL__TEXT__SEARCH_SOLR_URL
        value: 'http://{{ include "common.names.fullname" . }}-solr.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.service.solr.ports.solr.port }}/solr/docspell'

persistence:
  solr:
    enabled: true
    mountPath: "/var/solr"

# Enabled postgres
postgresql:
  enabled: true
  existingSecret: "dbcreds"
  postgresqlUsername: docspell
  postgresqlDatabase: docspell
